# üì¶ CONTEXTO COMPLETO - App Licencias Angel Android

## üéØ RESUMEN DEL PROYECTO

Estoy desarrollando una **app Android nativa** en Kotlin + Jetpack Compose que:

1. **Lee datos de pantalla** de DiDi con OCR (ML Kit)
2. **Calcula tarifas** autom√°ticamente ($/km, $/min, $/hora)
3. **Muestra overlay flotante** con los resultados
4. **Sistema de licencias mensuales** vinculadas a dispositivo (ANDROID_ID)
5. **Backend en Next.js 16** con API REST + MySQL
6. **Base de datos:** MySQL (ya est√° creada con procedimientos almacenados)

---

## üì± INFORMACI√ìN DEL PROYECTO ANDROID

### Package Name:
```
com.example.licenciasangel
```

### Configuraci√≥n:
```
- Android Studio: Hedgehog o superior
- Kotlin: 1.9.22
- Compose BOM: 2024.02.00
- Min SDK: 26 (Android 8.0)
- Target SDK: 34
- JDK: 17
```

---

## üìÅ ESTRUCTURA COMPLETA DEL PROYECTO

```
app/src/main/
‚îú‚îÄ‚îÄ AndroidManifest.xml
‚îú‚îÄ‚îÄ java/com/example/licenciasangel/
‚îÇ   ‚îú‚îÄ‚îÄ MainActivity.kt
‚îÇ   ‚îú‚îÄ‚îÄ MaiztroApp.kt
‚îÇ   ‚îú‚îÄ‚îÄ MaiztroApplication.kt
‚îÇ   ‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ApiService.kt (Retrofit + endpoints + Repository)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DatabaseManager.kt (Room DB + entities + DAOs)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PreferencesManager.kt (EncryptedSharedPreferences)
‚îÇ   ‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LicenseManager.kt (L√≥gica de licencias + validaci√≥n)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ OcrProcessor.kt (ML Kit + regex + c√°lculos)
‚îÇ   ‚îú‚îÄ‚îÄ ui/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CommonComponents.kt (Componentes reutilizables)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ screens/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthScreen.kt (Login/Register/Activate con tabs)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MainScreen.kt (Home/History/Settings con tabs)
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ OverlayService.kt (Servicio flotante + OCR + Accessibility)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ theme/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ Theme.kt (Material3 dark/light theme)
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îú‚îÄ‚îÄ Constants.kt (URLs, keys, patterns, configuraciones)
‚îÇ       ‚îî‚îÄ‚îÄ DeviceUtils.kt (ANDROID_ID, IMEI, device info)
‚îî‚îÄ‚îÄ res/
    ‚îú‚îÄ‚îÄ values/
    ‚îÇ   ‚îú‚îÄ‚îÄ strings.xml
    ‚îÇ   ‚îî‚îÄ‚îÄ themes.xml
    ‚îî‚îÄ‚îÄ xml/
        ‚îú‚îÄ‚îÄ accessibility_service_config.xml
        ‚îú‚îÄ‚îÄ data_extraction_rules.xml
        ‚îî‚îÄ‚îÄ backup_rules.xml
---

## üîå BACKEND - ENDPOINTS NEXT.JS

**Base URL:** (configurar en Constants.kt)
```kotlin
const val API_BASE_URL = "https://demo-licencias.vercel.app"
```
ahorita te pasare todos los endpoints que tengo xd 

## üóÑÔ∏è BASE DE DATOS MYSQL

### Tablas principales:
```sql
- usuarios (id_usuario, nombre_completo, email, telefono, password_hash)
- licencias (id_licencia, codigo_licencia, id_usuario, dispositivo_id, fecha_vencimiento, activa)
- viajes_registrados (id_viaje, id_usuario, monto, km_total, min_total, mxn_por_km, mxn_por_min, mxn_por_hora)
- administradores
- notificaciones
- historial_licencias
```

---

## üîê FLUJO DE LICENCIAS

admin es el unico que peude crear usuarios y activar licencias desde la pagina web ahora desde la aplicacion
movil debe valer solo el login y cuando el usuario se logea y en la base de datos de su cuenta no hay un
device_id osea esta vacio ese campo pues enviara el de su celular a las bases de datos tenemos endpoints que 
ya maneja eso despues lo demas ya sabes xd 
---

## üìä ARQUITECTURA DE LA APP

### Navigation:
```
Splash ‚Üí (verifica sesi√≥n y licencia)
  ‚îú‚îÄ> Auth (Login) si no tiene sesi√≥n o licencia
  ‚îî‚îÄ> Main (Home/History/Settings) si tiene sesi√≥n y licencia v√°lida
```

### Componentes clave:

#### MainActivity.kt
- Activity principal
- Inicializa: PreferencesManager, ApiRepository, DatabaseRepository, LicenseManager, OcrProcessor
- Solicita permisos (Overlay, Accessibility, Notifications)

#### MaiztroApp.kt
- NavHost con Compose Navigation
- Theme (Material3)
- SplashScreen con l√≥gica de redirecci√≥n

#### AuthScreen.kt (3 tabs)
- **Login:** email + password + device_id ‚Üí JWT token
- **Register:** datos completos ‚Üí crea usuario + token
- **Activate:** c√≥digo de licencia ‚Üí vincula a dispositivo

#### MainScreen.kt (3 tabs)
- **Home:** Estad√≠sticas, estado de licencia, control del servicio
- **History:** Lista de viajes guardados (LazyColumn)
- **Settings:** Info de usuario, renovar licencia, logout

#### OverlayService.kt
- **Foreground Service** para overlay flotante
- **AccessibilityService** para detectar DiDi abierto
- **OCR con ML Kit** ‚Üí extrae texto de pantalla
- **Regex patterns** ‚Üí captura monto, km, minutos
- **C√°lculos autom√°ticos** ‚Üí $/km, $/min, $/hora
- **UI Compose en Overlay** ‚Üí muestra resultados + botones Aceptar/Rechazar

#### LicenseManager.kt
- `checkLocalLicenseState()` ‚Üí Valid/Warning/Expired/NoLicense
- `activateLicense()` ‚Üí POST /api/license/activate
- `validateLicenseWithServer()` ‚Üí POST /api/license/validate
- `performHeartbeat()` ‚Üí verificaci√≥n peri√≥dica

#### OcrProcessor.kt
- `processScreenshot(Bitmap)` ‚Üí Result<TripData>
- Regex para extraer: MXN$XX.XX, XX min (XX km), X h
- Maneja conversi√≥n m ‚Üí km
- Calcula totales y tarifas

---

## üîß DEPENDENCIAS PRINCIPALES

```kotlin
// Compose
androidx.compose:compose-bom:2024.02.00

// Navigation
androidx.navigation:navigation-compose:2.7.6

// Retrofit
com.squareup.retrofit2:retrofit:2.9.0
com.squareup.okhttp3:okhttp:4.12.0

// Room
androidx.room:room-runtime:2.6.1
androidx.room:room-ktx:2.6.1

// Security
androidx.security:security-crypto:1.1.0-alpha06

// ML Kit
com.google.mlkit:text-recognition:16.0.0

// WorkManager
androidx.work:work-runtime-ktx:2.9.0

// Coroutines
org.jetbrains.kotlinx:kotlinx-coroutines-android:1.7.3
```

---

## ‚ö†Ô∏è PROBLEMAS CONOCIDOS Y SOLUCIONES

### 1. OCR no captura pantalla directamente
**Problema:** Android no permite screenshot directo sin permisos especiales
**Soluci√≥n:** Usar AccessibilityService para detectar contenido visible

### 2. Overlay consume bater√≠a
**Soluci√≥n:** Solo activar cuando DiDi est√° abierto, usar WorkManager optimizado

### 3. Licencia puede ser hackeada modificando SharedPreferences
**Soluci√≥n:** 
- EncryptedSharedPreferences
- Validaci√≥n en servidor cada 24h
- Device ID hasheado (no modificable)

### 4. Google Play puede rechazar por Accessibility
**Soluci√≥n:** Descripci√≥n MUY clara de por qu√© necesita el permiso

---

## üìù ARCHIVOS QUE NECESITO QUE REVISES

### Cuando me pases archivos, incluye:
#### 1. **build.gradle.kts (Module: app)**
#### 3. **AndroidManifest.xml** (si hay errores de permisos/servicios)
#### 4. **Constants.kt** (si cambias URLs o configuraciones)
```
View ‚Üí Tool Windows ‚Üí Logcat
Copia TODO el error en rojo
```